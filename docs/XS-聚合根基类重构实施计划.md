# 聚合根基类重构实施计划

> **版本**：v1.0.0
> **创建日期**：2026-02-18
> **状态**：待实施
> **前置文档**：`docs/XS-SAAS平台架构设计方案（全局演进版）.md`、`docs/XS-聚合根基类重构方案.md`

---

## 一、重构目标

### 1.1 核心目标

| 目标             | 描述                           | 优先级 |
| ---------------- | ------------------------------ | ------ |
| **消除代码重复** | 将 ~240 行样板代码抽取到基类   | 🔴 高  |
| **统一审计追踪** | 内置创建者、更新者、删除者追踪 | 🔴 高  |
| **内置软删除**   | 统一数据安全策略               | 🔴 高  |
| **支持未来发展** | 预留 AI、分析、同步扩展能力    | 🟡 中  |
| **保持向后兼容** | 不破坏现有功能                 | 🔴 高  |

### 1.2 预期收益

| 指标             | 当前      | 目标      |
| ---------------- | --------- | --------- |
| 聚合根样板代码   | ~60 行/个 | 0 行      |
| 新聚合根开发时间 | 2-3 天    | 0.5-1 天  |
| 审计追踪一致性   | 分散实现  | 100% 统一 |
| 软删除能力       | 部分实现  | 100% 内置 |

---

## 二、重构范围

### 2.1 涉及的聚合根

| 聚合根                      | 位置                    | 优先级 | 复杂度 |
| --------------------------- | ----------------------- | ------ | ------ |
| `BillingAggregate`          | `libs/domains/billing`  | 🔴 P0  | 中     |
| `UserAggregate`             | `libs/domains/identity` | 🔴 P0  | 高     |
| `TenantAggregate`           | `libs/domains/tenant`   | 🔴 P0  | 中     |
| `TenantMembershipAggregate` | `libs/domains/identity` | 🟡 P1  | 低     |

### 2.2 新增的共享包

| 包名                      | 位置                      | 职责       |
| ------------------------- | ------------------------- | ---------- |
| `@oksai/event-store` 扩展 | `libs/shared/event-store` | 聚合根基类 |

### 2.3 不涉及的范围

- 现有业务逻辑不改变
- 现有 API 接口不改变
- 现有数据库结构不改变（扩展字段通过可选方式添加）

---

## 三、阶段划分与依赖关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                         阶段依赖关系                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Phase 1 ─────────────► Phase 2 ─────────────► Phase 3              │
│  核心基类              聚合根迁移            测试与文档              │
│  (3-5天)               (5-7天)               (2-3天)                │
│                                                                     │
│                              │                                      │
│                              ▼                                      │
│                         Phase 4 (可选)                              │
│                         扩展基类                                    │
│                         (3-5天)                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 四、Phase 1：核心基类实现（3-5 天）

### 4.1 目标

在 `@oksai/event-store` 包中实现 `AggregateRoot` 核心基类。

### 4.2 任务清单

| #    | 任务                                                          | 负责人 | 预计工时 | 状态 |
| ---- | ------------------------------------------------------------- | ------ | -------- | ---- |
| 1.1  | 创建 `aggregate-root.ts` 文件                                 | -      | 2h       | ⏳   |
| 1.2  | 实现事件版本管理（committedVersion、version）                 | -      | 2h       | ⏳   |
| 1.3  | 实现领域事件管理（收集、提交、清空）                          | -      | 3h       | ⏳   |
| 1.4  | 实现审计时间戳（createdAt、updatedAt）                        | -      | 1h       | ⏳   |
| 1.5  | 实现审计追踪（createdBy、updatedBy）                          | -      | 2h       | ⏳   |
| 1.6  | 实现软删除能力（deletedAt、deletedBy、isDeleted）             | -      | 2h       | ⏳   |
| 1.7  | 实现 `getAuditInfo()` 方法                                    | -      | 1h       | ⏳   |
| 1.8  | 实现 `hasUncommittedEvents()` 和 `getUncommittedEventCount()` | -      | 1h       | ⏳   |
| 1.9  | 添加 `AuditInfo` 接口                                         | -      | 0.5h     | ⏳   |
| 1.10 | 编写单元测试                                                  | -      | 4h       | ⏳   |
| 1.11 | 更新包导出（index.ts）                                        | -      | 0.5h     | ⏳   |

### 4.3 文件结构

```
libs/shared/event-store/src/
├── lib/
│   ├── aggregate-root.ts          # 新增：聚合根基类
│   ├── audit-info.interface.ts    # 新增：审计信息接口
│   ├── event-store.module.ts
│   └── ...
├── index.ts                        # 更新：导出新增内容
└── ...
```

### 4.4 核心代码骨架

```typescript
// libs/shared/event-store/src/lib/aggregate-root.ts

/**
 * @description 聚合根基类
 *
 * 提供所有聚合根共享的基础能力
 */
export abstract class AggregateRoot<TEvent extends EventStoreDomainEvent = EventStoreDomainEvent> {
	// ==================== 事件版本管理 ====================
	protected committedVersion = 0;
	protected version = 0;

	// ==================== 领域事件管理 ====================
	private readonly _domainEvents: TEvent[] = [];

	// ==================== 审计时间戳 ====================
	protected _createdAt!: Date;
	protected _updatedAt!: Date;

	// ==================== 审计追踪 ====================
	protected _createdBy?: string;
	protected _updatedBy?: string;

	// ==================== 软删除 ====================
	protected _deletedAt?: Date;
	protected _deletedBy?: string;

	// ... 完整实现
}
```

### 4.5 验收标准

- [ ] `AggregateRoot` 类可编译无错误
- [ ] 所有公共方法有完整的 TSDoc 注释（中文）
- [ ] 单元测试覆盖率 ≥ 90%
- [ ] 可通过 `@oksai/event-store` 正常导入
- [ ] 不影响现有 `@oksai/event-store` 功能

### 4.6 回滚策略

- 新增文件，不修改现有代码
- 如有问题直接删除新增文件即可

---

## 五、Phase 2：聚合根迁移（5-7 天）

### 5.1 目标

将现有聚合根迁移到 `AggregateRoot` 基类。

### 5.2 迁移顺序

```
BillingAggregate ──────► UserAggregate ──────► TenantAggregate ──────► TenantMembershipAggregate
   (简单)                   (中等)                (简单)                   (简单)
```

### 5.3 任务清单

#### 5.3.1 BillingAggregate 迁移

| #     | 任务                                         | 预计工时 | 状态 |
| ----- | -------------------------------------------- | -------- | ---- |
| 2.1.1 | 修改 `BillingAggregate` 继承 `AggregateRoot` | 1h       | ⏳   |
| 2.1.2 | 移除重复的事件管理代码                       | 1h       | ⏳   |
| 2.1.3 | 移除重复的时间戳代码                         | 0.5h     | ⏳   |
| 2.1.4 | 添加审计追踪支持                             | 1h       | ⏳   |
| 2.1.5 | 更新工厂方法（create）                       | 1h       | ⏳   |
| 2.1.6 | 更新 rehydrate 方法                          | 1h       | ⏳   |
| 2.1.7 | 更新 apply 方法                              | 1h       | ⏳   |
| 2.1.8 | 更新单元测试                                 | 2h       | ⏳   |
| 2.1.9 | 运行集成测试验证                             | 1h       | ⏳   |

#### 5.3.2 UserAggregate 迁移

| #     | 任务                                      | 预计工时 | 状态 |
| ----- | ----------------------------------------- | -------- | ---- |
| 2.2.1 | 修改 `UserAggregate` 继承 `AggregateRoot` | 1h       | ⏳   |
| 2.2.2 | 移除重复代码                              | 1h       | ⏳   |
| 2.2.3 | 添加审计追踪支持                          | 1h       | ⏳   |
| 2.2.4 | 更新 disable/enable 方法（使用软删除）    | 2h       | ⏳   |
| 2.2.5 | 更新单元测试                              | 2h       | ⏳   |
| 2.2.6 | 运行集成测试验证                          | 1h       | ⏳   |

#### 5.3.3 TenantAggregate 迁移

| #     | 任务                                        | 预计工时 | 状态 |
| ----- | ------------------------------------------- | -------- | ---- |
| 2.3.1 | 修改 `TenantAggregate` 继承 `AggregateRoot` | 1h       | ⏳   |
| 2.3.2 | 移除重复代码                                | 1h       | ⏳   |
| 2.3.3 | 添加审计追踪支持                            | 1h       | ⏳   |
| 2.3.4 | 更新单元测试                                | 2h       | ⏳   |
| 2.3.5 | 运行集成测试验证                            | 1h       | ⏳   |

#### 5.3.4 TenantMembershipAggregate 迁移

| #     | 任务         | 预计工时 | 状态 |
| ----- | ------------ | -------- | ---- |
| 2.4.1 | 修改继承关系 | 1h       | ⏳   |
| 2.4.2 | 移除重复代码 | 1h       | ⏳   |
| 2.4.3 | 更新测试     | 2h       | ⏳   |

### 5.4 迁移示例

#### Before（当前）

```typescript
export class BillingAggregate {
	private readonly _domainEvents: BillingEvent[] = [];
	private committedVersion = 0;
	private version = 0;
	private _createdAt!: Date;
	private _updatedAt!: Date;

	// ... 大量重复代码
}
```

#### After（迁移后）

```typescript
export class BillingAggregate extends AggregateRoot<BillingEvent> {
	// 只保留业务属性
	private readonly _id: BillingId;
	private readonly _tenantId: string;
	private readonly _amount: Money;
	// ...

	// 业务方法保持不变
	markAsPaid(paymentMethod: string, transactionId: string): void {
		// 业务逻辑不变，但可以调用基类方法
		this._status = BillingStatus.PAID;
		this._paidAt = new Date();

		// 使用基类的 addDomainEvent
		this.addDomainEvent({
			eventType: 'BillingPaid',
			aggregateId: this._id.toString(),
			occurredAt: this._paidAt,
			eventData: {
				/* ... */
			},
			schemaVersion: 1
		});
	}
}
```

### 5.5 验收标准

- [ ] 所有 4 个聚合根迁移完成
- [ ] 现有单元测试全部通过
- [ ] 现有集成测试全部通过
- [ ] 现有 E2E 测试全部通过
- [ ] 代码重复行数减少 ≥ 200 行

### 5.6 回滚策略

- 每个聚合根迁移后创建 Git tag
- 出现问题可回滚到对应 tag
- 迁移期间保持旧代码路径可用

---

## 六、Phase 3：测试与文档（2-3 天）

### 6.1 目标

完善测试覆盖，更新相关文档。

### 6.2 任务清单

| #   | 任务                                     | 预计工时 | 状态 |
| --- | ---------------------------------------- | -------- | ---- |
| 3.1 | 补充聚合根基类集成测试                   | 3h       | ⏳   |
| 3.2 | 补充审计追踪场景测试                     | 2h       | ⏳   |
| 3.3 | 补充软删除场景测试                       | 2h       | ⏳   |
| 3.4 | 更新 `ARCHITECTURE.md`                   | 1h       | ⏳   |
| 3.5 | 更新 bounded-context 模板文档            | 1h       | ⏳   |
| 3.6 | 更新 `XS-聚合根基类重构方案.md` 标记完成 | 0.5h     | ⏳   |
| 3.7 | 创建迁移指南                             | 2h       | ⏳   |

### 6.3 测试场景清单

#### 6.3.1 事件管理测试

| 场景           | 描述                                  |
| -------------- | ------------------------------------- |
| 添加领域事件   | `addDomainEvent()` 正确添加事件       |
| 获取未提交事件 | `getUncommittedEvents()` 返回正确列表 |
| 提交事件       | `commitUncommittedEvents()` 清空缓冲  |
| 拉取事件       | `pullUncommittedEvents()` 返回并清空  |
| 版本控制       | version/committedVersion 正确递增     |

#### 6.3.2 审计追踪测试

| 场景         | 描述                                |
| ------------ | ----------------------------------- |
| 设置创建者   | `setCreatedBy()` 正确设置           |
| 设置更新者   | `setUpdatedBy()` 正确设置并更新时间 |
| 获取审计信息 | `getAuditInfo()` 返回完整信息       |

#### 6.3.3 软删除测试

| 场景     | 描述                             |
| -------- | -------------------------------- |
| 软删除   | `softDelete()` 设置 deletedAt    |
| 幂等删除 | 重复调用 `softDelete()` 无副作用 |
| 恢复     | `restore()` 清空 deletedAt       |
| 幂等恢复 | 重复调用 `restore()` 无副作用    |
| 状态检查 | `isDeleted()` 返回正确状态       |

### 6.4 验收标准

- [ ] 核心基类测试覆盖率 ≥ 90%
- [ ] 迁移后聚合根测试覆盖率 ≥ 80%
- [ ] 所有 E2E 测试通过
- [ ] 文档更新完成

---

## 七、Phase 4：扩展基类实现（可选，3-5 天）

### 7.1 目标

实现面向未来发展的扩展基类（AI、分析、同步）。

### 7.2 任务清单

| #   | 任务                           | 预计工时 | 状态 |
| --- | ------------------------------ | -------- | ---- |
| 4.1 | 实现 `AIEnabledAggregateRoot`  | 3h       | ✅   |
| 4.2 | 实现 `AnalyzableAggregateRoot` | 3h       | ✅   |
| 4.3 | 实现 `SyncableAggregateRoot`   | 3h       | ✅   |
| 4.4 | 添加 `EmbeddingStatus` 枚举    | 0.5h     | ✅   |
| 4.5 | 添加 `SyncStatus` 枚举         | 0.5h     | ✅   |
| 4.6 | 添加相关接口                   | 1h       | ✅   |
| 4.7 | 编写单元测试（34 个测试用例）  | 4h       | ✅   |

### 7.3 验收标准

- [x] 三个扩展基类可编译
- [x] 单元测试覆盖率 ≥ 80%（58 个测试用例全部通过）
- [x] 可正常继承使用

---

## 八、风险管理

### 8.1 风险清单

| 风险             | 等级  | 概率 | 影响 | 缓解措施             |
| ---------------- | ----- | ---- | ---- | -------------------- |
| 迁移导致功能回归 | 🔴 高 | 中   | 高   | 渐进式迁移，每步验证 |
| 测试覆盖不足     | 🟡 中 | 中   | 中   | 优先补充核心场景测试 |
| 性能影响         | 🟢 低 | 低   | 低   | 可选字段不增加开销   |
| 团队不熟悉新架构 | 🟡 中 | 高   | 中   | 提供示例和文档       |

### 8.2 回滚策略

| 阶段    | 回滚方式                 |
| ------- | ------------------------ |
| Phase 1 | 删除新增文件             |
| Phase 2 | Git 回滚到迁移前 tag     |
| Phase 3 | 无需回滚（仅测试和文档） |
| Phase 4 | 删除扩展基类文件         |

---

## 九、时间规划

### 9.1 甘特图

```
周次    Week 1          Week 2          Week 3
      ┌─────────────────────────────────────────────┐
Phase1│████████████                                    │
      │  核心基类实现                                  │
      ├─────────────────────────────────────────────┤
Phase2│          ████████████████████████████████    │
      │                  聚合根迁移                  │
      ├─────────────────────────────────────────────┤
Phase3│                                  ████████████│
      │                                  测试与文档  │
      ├─────────────────────────────────────────────┤
Phase4│(可选)                              ████████████│
      │(可选)                              扩展基类  │
      └─────────────────────────────────────────────┘
```

### 9.2 里程碑

| 里程碑 | 日期        | 交付物             |
| ------ | ----------- | ------------------ |
| M1     | Week 1 结束 | 核心基类实现完成   |
| M2     | Week 2 结束 | 所有聚合根迁移完成 |
| M3     | Week 3 结束 | 测试和文档完成     |
| M4     | (可选)      | 扩展基类实现完成   |

---

## 十、验收总清单

### 10.1 功能验收

- [ ] `AggregateRoot` 核心基类实现完成
- [ ] 所有聚合根迁移到新基类
- [ ] 审计追踪功能可用
- [ ] 软删除功能可用
- [ ] 事件管理功能正常

### 10.2 质量验收

- [ ] 核心基类单元测试覆盖率 ≥ 90%
- [ ] 聚合根测试覆盖率 ≥ 80%
- [ ] 所有现有 E2E 测试通过
- [ ] 无 TypeScript 编译错误

### 10.3 文档验收

- [ ] `ARCHITECTURE.md` 更新
- [ ] bounded-context 模板更新
- [ ] 迁移指南完成
- [ ] TSDoc 注释完整（中文）

---

## 十一、后续工作

完成本次重构后的建议后续工作：

1. **创建文档聚合根**：使用 `AIEnabledAggregateRoot` 实现知识库功能
2. **创建报表聚合根**：使用 `AnalyzableAggregateRoot` 实现数据分析
3. **集成外部系统**：使用 `SyncableAggregateRoot` 对接数据仓库
4. **完善扩展基类**：根据实际使用反馈优化扩展能力

---

## 十二、文档元信息

| 字段         | 值         |
| ------------ | ---------- |
| **版本**     | v1.2.0     |
| **创建日期** | 2026-02-18 |
| **最后更新** | 2026-02-18 |
| **维护者**   | Oksai Team |

### 变更记录

| 版本   | 日期       | 变更内容                                                              |
| ------ | ---------- | --------------------------------------------------------------------- |
| v1.0.0 | 2026-02-18 | 初始版本                                                              |
| v1.1.0 | 2026-02-18 | Phase 1-2 完成：核心基类实现、4 个聚合根迁移完成                      |
| v1.2.0 | 2026-02-18 | Phase 4 完成：三个扩展基类实现（AI/分析/同步），58 个测试用例全部通过 |

### 相关文档

- `docs/XS-SAAS平台架构设计方案（全局演进版）.md`
- `docs/XS-聚合根基类重构方案.md`
- `docs/ARCHITECTURE.md`
- `docs/XS-领域模型增强计划（Rich Model + ES 混合架构）.md`
